# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: checksum tests
templates:
  - event-reporters/**/deployment.yaml
  - event-reporters/**/configmap.yaml
  - argo-gateway/deployment.yaml
  - argo-gateway/configmap.yaml
  - app-proxy/deployment.yaml
  - app-proxy/config.yaml
  - _components/cap-app-proxy/_deployment.yaml
  - _components/cap-app-proxy/_config.yaml
  - codefresh-cm.yaml
tests:
- it: default checksum annotations is present
  values:
  - ./values/mandatory-values-ingress.yaml
  asserts:
  - equal:
      path: spec.template.metadata.annotations["checksum/config-argo-gateway"]
      value: ab112b8010e1534e8b45f746764af03ca4e7c9fa5cd0a01f04830e0a6c6e77e1
    template: argo-gateway/deployment.yaml
  - equal:
      path: spec.template.metadata.annotations["checksum/config-codefresh-cm"]
      value: 4fa7b6b4939725018068441ee7ea7ec594c30d6e58020fdaa89b07ca9515b650
    template: argo-gateway/deployment.yaml
  - equal:
      path: spec.template.metadata.annotations["checksum/config-event-reporter"]
      value: d016ba2b10b22e24da8854027d4e3fccfe02ee3db4441512ba38a0eb34e124f5
    template: event-reporters/cluster-event-reporter/deployment.yaml
  - equal:
      path: spec.template.metadata.annotations["checksum/config-codefresh-cm"]
      value: 4fa7b6b4939725018068441ee7ea7ec594c30d6e58020fdaa89b07ca9515b650
    template: event-reporters/cluster-event-reporter/deployment.yaml
  - equal:
      path: spec.template.metadata.annotations["checksum/config-argocd"]
      value: 4ae1efd920b2b1b83a9b74fabd84defe9869f7c66a444bcfd4ce7dbb5cb846c8
    template: event-reporters/cluster-event-reporter/deployment.yaml
  - equal:
      path: spec.template.metadata.annotations["checksum/config-cap-app-proxy"]
      value: 8963a9c81220fd8440ccc4e8675be794c83988751fd0d8591c60b2cd3923fbd4
    template: app-proxy/deployment.yaml
  - equal:
      path: spec.template.metadata.annotations["checksum/config-codefresh-cm"]
      value: 4fa7b6b4939725018068441ee7ea7ec594c30d6e58020fdaa89b07ca9515b650
    template: app-proxy/deployment.yaml

- it: checksum annotations should change when configmap changes
  template: argo-gateway/deployment.yaml
  set:
    argo-cd.enabled: false
    global.integrations.argo-cd.server.svc: my-argocd-server
  values:
  - ./values/mandatory-values-ingress.yaml
  asserts:
  - equal:
      path: spec.template.metadata.annotations["checksum/config-argo-gateway"]
      value: 89ba18c028caf3aafa73763816296570ec6d82afafa8744419773a4be6d84aff
    template: argo-gateway/deployment.yaml
  - equal:
      path: spec.template.metadata.annotations["checksum/config-codefresh-cm"]
      value: 6fc94d431ae6064fddc76734ec7c66d8b60af02cb22d9b1298e8403a8adcda82
    template: argo-gateway/deployment.yaml
  - equal:
      path: spec.template.metadata.annotations["checksum/config-event-reporter"]
      value: e76508c530cbb199da90e2dfee0ecb4b6ce79ed86e2b5368c3d670b5ccc9fbe2
    template: event-reporters/cluster-event-reporter/deployment.yaml
  - equal:
      path: spec.template.metadata.annotations["checksum/config-codefresh-cm"]
      value: 6fc94d431ae6064fddc76734ec7c66d8b60af02cb22d9b1298e8403a8adcda82
    template: event-reporters/cluster-event-reporter/deployment.yaml
  - equal:
      path: spec.template.metadata.annotations["checksum/config-cap-app-proxy"]
      value: b302ea8929baccb98f9b0086987f76de6e3591e72f356915d951e6a6437611f6
    template: app-proxy/deployment.yaml
  - equal:
      path: spec.template.metadata.annotations["checksum/config-codefresh-cm"]
      value: 6fc94d431ae6064fddc76734ec7c66d8b60af02cb22d9b1298e8403a8adcda82
    template: app-proxy/deployment.yaml
