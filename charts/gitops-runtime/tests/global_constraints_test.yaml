suite: Test global constraints (nodeSelector, tolerations)
templates:
  - app-proxy/deployment.yaml
  - cf-argocd-extras/**
  - gitops-operator/*
  - _components/cf-argocd-extras/**
  - _components/gitops-operator/*
  - tunnel-client.yaml
  - charts/codefresh-tunnel-client/*
  - internal-router/deployment.yaml
  - event-reporters/rollout-reporter/eventsource.yaml
  - event-reporters/rollout-reporter/sensor.yaml
  - event-reporters/workflow-reporter/eventsource.yaml
  - event-reporters/workflow-reporter/sensor.yaml
  - eventbus/codefresh-eventbus.yaml
  - hooks/pre-install/validate-values.yaml
  - hooks/pre-install/validate-usage.yaml
  - hooks/pre-uninstall/cleanup-resources.yaml
  - hooks/pre-uninstall/delete-runtime-from-platform.yaml
  - charts/argo-events/*
  - charts/argo-rollouts/*
  - charts/argo-workflows/*
values:
  - ./values/mandatory-values.yaml
tests:
  - it: cap-app-proxy should have nodeSelector and tolerations from .Values.global
    values:
      - ./values/global-constraints-values.yaml
    template: app-proxy/deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: some-key
              operator: Equal
              value: some-value
              effect: NoSchedule

  - it: cap-app-proxy should have nodeSelector and tolerations from .Values.app-proxy and NOT from .Values.global
    values:
      - ./values/global-constraints-values.yaml
      - ./values/subcharts-constraints-values.yaml
    template: app-proxy/deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: another-value
            foo: bar
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: another-key
              operator: Equal
              value: another-value
              effect: NoSchedule

  - it: internal-router should have nodeSelector and tolerations from .Values.global
    values:
      - ./values/global-constraints-values.yaml
    template: internal-router/deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: some-key
              operator: Equal
              value: some-value
              effect: NoSchedule

  - it: internal-router should have nodeSelector and tolerations from .Values.internal-router and NOT from .Values.global
    values:
      - ./values/global-constraints-values.yaml
      - ./values/subcharts-constraints-values.yaml
    template: internal-router/deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: another-value
            foo: bar
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: another-key
              operator: Equal
              value: another-value
              effect: NoSchedule

  - it: rollout-reporter eventsource should have nodeSelector and tolerations from .Values.global
    values:
      - ./values/global-constraints-values.yaml
    template: event-reporters/rollout-reporter/eventsource.yaml
    asserts:
      - equal:
          path: spec.template.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
      - equal:
          path: spec.template.tolerations
          value:
            - key: some-key
              operator: Equal
              value: some-value
              effect: NoSchedule

  - it: rollout-reporter eventsource should have nodeSelector and tolerations from .Values.event-reporters and NOT from .Values.global
    values:
      - ./values/global-constraints-values.yaml
      - ./values/subcharts-constraints-values.yaml
    template: event-reporters/rollout-reporter/eventsource.yaml
    asserts:
      - equal:
          path: spec.template.nodeSelector
          value:
            some-key: another-value
            foo: bar
      - equal:
          path: spec.template.tolerations
          value:
            - key: another-key
              operator: Equal
              value: another-value
              effect: NoSchedule

  - it: rollout-reporter sensor should have nodeSelector and tolerations from .Values.global
    values:
      - ./values/global-constraints-values.yaml
    template: event-reporters/rollout-reporter/sensor.yaml
    asserts:
      - equal:
          path: spec.template.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
      - equal:
          path: spec.template.tolerations
          value:
            - key: some-key
              operator: Equal
              value: some-value
              effect: NoSchedule

  - it: rollout-reporter sensor should have nodeSelector and tolerations from .Values.event-reporters and NOT from .Values.global
    values:
      - ./values/global-constraints-values.yaml
      - ./values/subcharts-constraints-values.yaml
    template: event-reporters/rollout-reporter/sensor.yaml
    asserts:
      - equal:
          path: spec.template.nodeSelector
          value:
            some-key: another-value
            foo: bar
      - equal:
          path: spec.template.tolerations
          value:
            - key: another-key
              operator: Equal
              value: another-value
              effect: NoSchedule

  - it: workflow-reporter eventsource should have nodeSelector and tolerations from .Values.global
    values:
      - ./values/global-constraints-values.yaml
    template: event-reporters/workflow-reporter/eventsource.yaml
    asserts:
      - equal:
          path: spec.template.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
      - equal:
          path: spec.template.tolerations
          value:
            - key: some-key
              operator: Equal
              value: some-value
              effect: NoSchedule

  - it: workflow-reporter eventsource should have nodeSelector and tolerations from .Values.event-reporters and NOT from .Values.global
    values:
      - ./values/global-constraints-values.yaml
      - ./values/subcharts-constraints-values.yaml
    template: event-reporters/workflow-reporter/eventsource.yaml
    asserts:
      - equal:
          path: spec.template.nodeSelector
          value:
            some-key: another-value
            foo: bar
      - equal:
          path: spec.template.tolerations
          value:
            - key: another-key
              operator: Equal
              value: another-value
              effect: NoSchedule

  - it: workflow-reporter sensor should have nodeSelector and tolerations from .Values.global
    values:
      - ./values/global-constraints-values.yaml
    template: event-reporters/workflow-reporter/sensor.yaml
    asserts:
      - equal:
          path: spec.template.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
      - equal:
          path: spec.template.tolerations
          value:
            - key: some-key
              operator: Equal
              value: some-value
              effect: NoSchedule

  - it: workflow-reporter sensor should have nodeSelector and tolerations from .Values.event-reporters and NOT from .Values.global
    values:
      - ./values/global-constraints-values.yaml
      - ./values/subcharts-constraints-values.yaml
    template: event-reporters/workflow-reporter/sensor.yaml
    asserts:
      - equal:
          path: spec.template.nodeSelector
          value:
            some-key: another-value
            foo: bar
      - equal:
          path: spec.template.tolerations
          value:
            - key: another-key
              operator: Equal
              value: another-value
              effect: NoSchedule

  - it: codefresh-eventbus should have nodeSelector and tolerations from .Values.global
    values:
      - ./values/global-constraints-values.yaml
    template: eventbus/codefresh-eventbus.yaml
    asserts:
      - equal:
          path: spec.nats.native.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
      - equal:
          path: spec.nats.native.tolerations
          value:
            - key: some-key
              operator: Equal
              value: some-value
              effect: NoSchedule

  - it: codefresh-eventbus should have nodeSelector and tolerations from .Values.eventbus and NOT from .Values.global
    values:
      - ./values/global-constraints-values.yaml
      - ./values/subcharts-constraints-values.yaml
    template: eventbus/codefresh-eventbus.yaml
    asserts:
      - equal:
          path: spec.nats.native.nodeSelector
          value:
            some-key: another-value
            foo: bar
      - equal:
          path: spec.nats.native.tolerations
          value:
            - key: another-key
              operator: Equal
              value: another-value
              effect: NoSchedule

  - it: validate-values job should have nodeSelector and tolerations from .Values.global
    values:
      - ./values/global-constraints-values.yaml
    template: hooks/pre-install/validate-values.yaml
    documentSelector:
      path: kind
      value: Job
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: some-key
              operator: Equal
              value: some-value
              effect: NoSchedule

  - it: validate-values job should have nodeSelector and tolerations from .Values.installer and NOT from .Values.global
    values:
      - ./values/global-constraints-values.yaml
      - ./values/subcharts-constraints-values.yaml
    template: hooks/pre-install/validate-values.yaml
    documentSelector:
      path: kind
      value: Job
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: another-value
            foo: bar
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: another-key
              operator: Equal
              value: another-value
              effect: NoSchedule

  - it: validate-usage job should have nodeSelector and tolerations from .Values.global
    values:
      - ./values/global-constraints-values.yaml
    template: hooks/pre-install/validate-usage.yaml
    documentSelector:
      path: kind
      value: Job
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: some-key
              operator: Equal
              value: some-value
              effect: NoSchedule

  - it: validate-usage job should have nodeSelector and tolerations from .Values.installer and NOT from .Values.global
    values:
      - ./values/global-constraints-values.yaml
      - ./values/subcharts-constraints-values.yaml
    template: hooks/pre-install/validate-usage.yaml
    documentSelector:
      path: kind
      value: Job
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: another-value
            foo: bar
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: another-key
              operator: Equal
              value: another-value
              effect: NoSchedule

  - it: cleanup-resources job should have nodeSelector and tolerations from .Values.global
    values:
      - ./values/global-constraints-values.yaml
    template: hooks/pre-uninstall/cleanup-resources.yaml
    documentSelector:
      path: kind
      value: Job
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: some-key
              operator: Equal
              value: some-value
              effect: NoSchedule

  - it: cleanup-resources job should have nodeSelector and tolerations from .Values.installer and NOT from .Values.global
    values:
      - ./values/global-constraints-values.yaml
      - ./values/subcharts-constraints-values.yaml
    template: hooks/pre-uninstall/cleanup-resources.yaml
    documentSelector:
      path: kind
      value: Job
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: another-value
            foo: bar
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: another-key
              operator: Equal
              value: another-value
              effect: NoSchedule

  - it: delete-runtime-from-platform job should have nodeSelector and tolerations from .Values.global
    values:
      - ./values/global-constraints-values.yaml
    template: hooks/pre-uninstall/delete-runtime-from-platform.yaml
    documentSelector:
      path: kind
      value: Job
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: some-key
              operator: Equal
              value: some-value
              effect: NoSchedule

  - it: delete-runtime-from-platform job should have nodeSelector and tolerations from .Values.installer and NOT from .Values.global
    values:
      - ./values/global-constraints-values.yaml
      - ./values/subcharts-constraints-values.yaml
    template: hooks/pre-uninstall/delete-runtime-from-platform.yaml
    documentSelector:
      path: kind
      value: Job
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: another-value
            foo: bar
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: another-key
              operator: Equal
              value: another-value
              effect: NoSchedule

  - it: sources-server should have nodeSelector from .Values.global
    values:
      - ./values/global-constraints-values.yaml
    template: cf-argocd-extras/sources-server/deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
      - equal:
          path: spec.template.spec.tolerations
          value:
          - key: some-key
            operator: Equal
            value: some-value
            effect: NoSchedule

  - it: sources-server should have nodeSelector and tolerations from and .Values.sources-server and NOT from .Values.global
    values:
      - ./values/global-constraints-values.yaml
      - ./values/subcharts-constraints-values.yaml
    template: cf-argocd-extras/sources-server/deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: another-value
            foo: bar
      - equal:
          path: spec.template.spec.tolerations
          value:
          - key: another-key
            operator: Equal
            value: another-value
            effect: NoSchedule

  - it: event-reporter should have nodeSelector and tolerations from .Values.global
    values:
      - ./values/global-constraints-values.yaml
      - ./values/external-argocd-values.yaml
    template: cf-argocd-extras/event-reporter/statefulset.yaml
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
      - equal:
          path: spec.template.spec.tolerations
          value:
          - key: some-key
            operator: Equal
            value: some-value
            effect: NoSchedule

  - it: event-reporter should have nodeSelector and tolerations from and .Values.event-reporter and NOT from .Values.global
    values:
      - ./values/global-constraints-values.yaml
      - ./values/subcharts-constraints-values.yaml
      - ./values/external-argocd-values.yaml
    template: cf-argocd-extras/event-reporter/statefulset.yaml
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: another-value
            foo: bar
      - equal:
          path: spec.template.spec.tolerations
          value:
          - key: another-key
            operator: Equal
            value: another-value
            effect: NoSchedule

  - it: gitops-operator should have nodeSelector and tolerations from .Values.global
    values:
      - ./values/global-constraints-values.yaml
    template: gitops-operator/deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
      - equal:
          path: spec.template.spec.tolerations
          value:
          - key: some-key
            operator: Equal
            value: some-value
            effect: NoSchedule

  - it: gitops-operator should have nodeSelector and tolerations from and .Values.gitops-operator and NOT from .Values.global
    values:
      - ./values/global-constraints-values.yaml
      - ./values/subcharts-constraints-values.yaml
    template: gitops-operator/deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: another-value
            foo: bar
      - equal:
          path: spec.template.spec.tolerations
          value:
          - key: another-key
            operator: Equal
            value: another-value
            effect: NoSchedule

  - it: tunnel-client should have nodeSelector and tolerations from .Values.global
    values:
      - ./values/global-constraints-values.yaml
    template: tunnel-client.yaml
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
      - equal:
          path: spec.template.spec.tolerations
          value:
          - key: some-key
            operator: Equal
            value: some-value
            effect: NoSchedule

  - it: tunnel-client should have nodeSelector and tolerations from and .Values.tunnel-client and NOT from .Values.global
    values:
      - ./values/global-constraints-values.yaml
      - ./values/subcharts-constraints-values.yaml
    template: tunnel-client.yaml
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: another-value
            foo: bar
      - equal:
          path: spec.template.spec.tolerations
          value:
          - key: another-key
            operator: Equal
            value: another-value
            effect: NoSchedule

  - it: argo-events-controller should have nodeSelector and tolerations from .Values.global
    values:
      - ./values/global-constraints-values.yaml
    template: charts/argo-events/templates/argo-events-controller/deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: some-key
              operator: Equal
              value: some-value
              effect: NoSchedule

  - it: argo-events-controller should have nodeSelector and tolerations from and .Values.argo-events and NOT from .Values.global
    values:
      - ./values/global-constraints-values.yaml
      - ./values/subcharts-constraints-values.yaml
    template: charts/argo-events/templates/argo-events-controller/deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: another-value
            foo: bar
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: another-key
              operator: Equal
              value: another-value
              effect: NoSchedule

  - it: argo-events-webhook should have nodeSelector and tolerations from .Values.global
    values:
      - ./values/global-constraints-values.yaml
    template: charts/argo-events/templates/argo-events-webhook/deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: some-key
              operator: Equal
              value: some-value
              effect: NoSchedule

  - it: argo-events-webhook should have nodeSelector and tolerations from and .Values.argo-events and NOT from .Values.global
    values:
      - ./values/global-constraints-values.yaml
      - ./values/subcharts-constraints-values.yaml
    template: charts/argo-events/templates/argo-events-webhook/deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: another-value
            foo: bar
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: another-key
              operator: Equal
              value: another-value
              effect: NoSchedule

  - it: argo-rollouts controller should have nodeSelector and tolerations from .Values.global
    values:
      - ./values/global-constraints-values.yaml
    template: charts/argo-rollouts/templates/controller/deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: some-key
              operator: Equal
              value: some-value
              effect: NoSchedule

  - it: argo-rollouts controller should have nodeSelector and tolerations from and .Values.argo-rollouts and NOT from .Values.global
    values:
      - ./values/global-constraints-values.yaml
      - ./values/subcharts-constraints-values.yaml
    template: charts/argo-rollouts/templates/controller/deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: another-value
            foo: bar
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: another-key
              operator: Equal
              value: another-value
              effect: NoSchedule

  - it: argo-workflow controller should have nodeSelector and tolerations from .Values.global
    values:
      - ./values/global-constraints-values.yaml
    template: charts/argo-workflows/templates/controller/workflow-controller-deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: some-key
              operator: Equal
              value: some-value
              effect: NoSchedule

  - it: argo-workflow controller should have nodeSelector and tolerations from and .Values.argo-workflows and NOT from .Values.global
    values:
      - ./values/global-constraints-values.yaml
      - ./values/subcharts-constraints-values.yaml
    template: charts/argo-workflows/templates/controller/workflow-controller-deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: another-value
            foo: bar
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: another-key
              operator: Equal
              value: another-value
              effect: NoSchedule

  - it: argo-workflow server should have nodeSelector and tolerations from .Values.global
    values:
      - ./values/global-constraints-values.yaml
    template: charts/argo-workflows/templates/server/server-deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: some-key
              operator: Equal
              value: some-value
              effect: NoSchedule

  - it: argo-workflow server should have nodeSelector and tolerations from and .Values.argo-workflows and NOT from .Values.global
    values:
      - ./values/global-constraints-values.yaml
      - ./values/subcharts-constraints-values.yaml
    template: charts/argo-workflows/templates/server/server-deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: another-value
            foo: bar
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: another-key
              operator: Equal
              value: another-value
              effect: NoSchedule
