suite: Test global constraints (nodeSelector, tolerations)
templates:
  - app-proxy/deployment.yaml
  - gitops-operator/*
  - event-reporters/**
  - argo-gateway/**
  - _components/gitops-operator/*
  - tunnel-client.yaml
  - charts/codefresh-tunnel-client/*
  - internal-router/deployment.yaml
  - eventbus/codefresh-eventbus.yaml
  - hooks/pre-install/validate-values.yaml
  - hooks/pre-install/validate-usage.yaml
  - hooks/pre-uninstall/cleanup-resources.yaml
  - hooks/pre-uninstall/delete-runtime-from-platform.yaml
  - charts/argo-events/*
  - charts/argo-rollouts/*
  - charts/argo-workflows/*
values:
  - ./values/mandatory-values.yaml
tests:
  - it: components should have nodeSelector and tolerations from .Values.global
    values:
      - ./values/global-constraints-values.yaml
    asserts:
      # -- cap-app-proxy
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
        template: app-proxy/deployment.yaml
      - equal:
          path: spec.template.spec.tolerations
          value:
          - key: some-key
            operator: Equal
            value: some-value
            effect: NoSchedule
        template: app-proxy/deployment.yaml
      # -- internal-router
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
        template: internal-router/deployment.yaml
      - equal:
          path: spec.template.spec.tolerations
          value:
          - key: some-key
            operator: Equal
            value: some-value
            effect: NoSchedule
        template: internal-router/deployment.yaml
      # -- runtime-event-reporter
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
        template: event-reporters/runtime-event-reporter/deployment.yaml
      - equal:
          path: spec.template.spec.tolerations
          value:
          - key: some-key
            operator: Equal
            value: some-value
            effect: NoSchedule
        template: event-reporters/runtime-event-reporter/deployment.yaml
      # -- argo-gateway
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
        template: argo-gateway/deployment.yaml
      - equal:
          path: spec.template.spec.tolerations
          value:
          - key: some-key
            operator: Equal
            value: some-value
            effect: NoSchedule
        template: argo-gateway/deployment.yaml
      # -- codefresh-eventbus
      - equal:
          path: spec.nats.native.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
        template: eventbus/codefresh-eventbus.yaml
      - equal:
          path: spec.nats.native.tolerations
          value:
          - key: some-key
            operator: Equal
            value: some-value
            effect: NoSchedule
        template: eventbus/codefresh-eventbus.yaml
      # -- validate-values job
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
        template: hooks/pre-install/validate-values.yaml
        documentSelector:
          path: kind
          value: Job
      - equal:
          path: spec.template.spec.tolerations
          value:
          - key: some-key
            operator: Equal
            value: some-value
            effect: NoSchedule
        template: hooks/pre-install/validate-values.yaml
        documentSelector:
          path: kind
          value: Job
      # -- validate-usage job
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
        template: hooks/pre-install/validate-usage.yaml
        documentSelector:
          path: kind
          value: Job
      - equal:
          path: spec.template.spec.tolerations
          value:
          - key: some-key
            operator: Equal
            value: some-value
            effect: NoSchedule
        template: hooks/pre-install/validate-usage.yaml
        documentSelector:
          path: kind
          value: Job
      # -- cleanup-resources job
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
        template: hooks/pre-uninstall/cleanup-resources.yaml
        documentSelector:
          path: kind
          value: Job
      - equal:
          path: spec.template.spec.tolerations
          value:
          - key: some-key
            operator: Equal
            value: some-value
            effect: NoSchedule
        template: hooks/pre-uninstall/cleanup-resources.yaml
        documentSelector:
          path: kind
          value: Job
      # -- delete-runtime-from-platform job
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
        template: hooks/pre-uninstall/delete-runtime-from-platform.yaml
        documentSelector:
          path: kind
          value: Job
      - equal:
          path: spec.template.spec.tolerations
          value:
          - key: some-key
            operator: Equal
            value: some-value
            effect: NoSchedule
        template: hooks/pre-uninstall/delete-runtime-from-platform.yaml
        documentSelector:
          path: kind
          value: Job
      # -- sources-server
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
        template: argo-gateway/deployment.yaml
      - equal:
          path: spec.template.spec.tolerations
          value:
          - key: some-key
            operator: Equal
            value: some-value
            effect: NoSchedule
        template: argo-gateway/deployment.yaml
      # -- event-reporter
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
        template: event-reporters/runtime-event-reporter/deployment.yaml
      - equal:
          path: spec.template.spec.tolerations
          value:
          - key: some-key
            operator: Equal
            value: some-value
            effect: NoSchedule
        template: event-reporters/runtime-event-reporter/deployment.yaml
      # -- gitops-operator
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
        template: gitops-operator/deployment.yaml
      - equal:
          path: spec.template.spec.tolerations
          value:
          - key: some-key
            operator: Equal
            value: some-value
            effect: NoSchedule
        template: gitops-operator/deployment.yaml
      # -- tunnel-client
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
        template: tunnel-client.yaml
        documentSelector:
          path: kind
          value: Deployment
      - equal:
          path: spec.template.spec.tolerations
          value:
          - key: some-key
            operator: Equal
            value: some-value
            effect: NoSchedule
        template: tunnel-client.yaml
        documentSelector:
          path: kind
          value: Deployment
      # -- argo-rollouts controller
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
        template: charts/argo-rollouts/templates/controller/deployment.yaml
      - equal:
          path: spec.template.spec.tolerations
          value:
          - key: some-key
            operator: Equal
            value: some-value
            effect: NoSchedule
        template: charts/argo-rollouts/templates/controller/deployment.yaml
      # -- argo-workflow controller
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
        template: charts/argo-workflows/templates/controller/workflow-controller-deployment.yaml
      - equal:
          path: spec.template.spec.tolerations
          value:
          - key: some-key
            operator: Equal
            value: some-value
            effect: NoSchedule
        template: charts/argo-workflows/templates/controller/workflow-controller-deployment.yaml
      # -- argo-workflow server
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: some-value
            extra-key: extra-value
        template: charts/argo-workflows/templates/server/server-deployment.yaml
      - equal:
          path: spec.template.spec.tolerations
          value:
          - key: some-key
            operator: Equal
            value: some-value
            effect: NoSchedule
        template: charts/argo-workflows/templates/server/server-deployment.yaml

  - it: components should have nodeSelector and tolerations from local values and NOT from .Values.global
    values:
      - ./values/global-constraints-values.yaml
      - ./values/subcharts-constraints-values.yaml
      - ./values/external-argocd-values.yaml
    asserts:
      # -- cap-app-proxy
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: another-value
            foo: bar
        template: app-proxy/deployment.yaml
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: another-key
              operator: Equal
              value: another-value
              effect: NoSchedule
        template: app-proxy/deployment.yaml
      # -- internal-router
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: another-value
            foo: bar
        template: internal-router/deployment.yaml
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: another-key
              operator: Equal
              value: another-value
              effect: NoSchedule
        template: internal-router/deployment.yaml
      # -- codefresh-eventbus
      - equal:
          path: spec.nats.native.nodeSelector
          value:
            some-key: another-value
            foo: bar
        template: eventbus/codefresh-eventbus.yaml
      - equal:
          path: spec.nats.native.tolerations
          value:
            - key: another-key
              operator: Equal
              value: another-value
              effect: NoSchedule
        template: eventbus/codefresh-eventbus.yaml
      # -- validate-values job
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: another-value
            foo: bar
        template: hooks/pre-install/validate-values.yaml
        documentSelector:
          path: kind
          value: Job
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: another-key
              operator: Equal
              value: another-value
              effect: NoSchedule
        template: hooks/pre-install/validate-values.yaml
        documentSelector:
          path: kind
          value: Job
      # -- validate-usage job
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: another-value
            foo: bar
        template: hooks/pre-install/validate-usage.yaml
        documentSelector:
          path: kind
          value: Job
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: another-key
              operator: Equal
              value: another-value
              effect: NoSchedule
        template: hooks/pre-install/validate-usage.yaml
        documentSelector:
          path: kind
          value: Job
      # -- cleanup-resources job
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: another-value
            foo: bar
        template: hooks/pre-uninstall/cleanup-resources.yaml
        documentSelector:
          path: kind
          value: Job
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: another-key
              operator: Equal
              value: another-value
              effect: NoSchedule
        template: hooks/pre-uninstall/cleanup-resources.yaml
        documentSelector:
          path: kind
          value: Job
      # -- delete-runtime-from-platform job
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: another-value
            foo: bar
        template: hooks/pre-uninstall/delete-runtime-from-platform.yaml
        documentSelector:
          path: kind
          value: Job
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: another-key
              operator: Equal
              value: another-value
              effect: NoSchedule
        template: hooks/pre-uninstall/delete-runtime-from-platform.yaml
        documentSelector:
          path: kind
          value: Job
      # -- sources-server
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: another-value
            foo: bar
        template: argo-gateway/deployment.yaml
      - equal:
          path: spec.template.spec.tolerations
          value:
          - key: another-key
            operator: Equal
            value: another-value
            effect: NoSchedule
        template: argo-gateway/deployment.yaml
      # -- event-reporter
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: another-value
            foo: bar
        template: event-reporters/runtime-event-reporter/deployment.yaml
      - equal:
          path: spec.template.spec.tolerations
          value:
          - key: another-key
            operator: Equal
            value: another-value
            effect: NoSchedule
        template: event-reporters/runtime-event-reporter/deployment.yaml
      # -- gitops-operator
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: another-value
            foo: bar
        template: gitops-operator/deployment.yaml
      - equal:
          path: spec.template.spec.tolerations
          value:
          - key: another-key
            operator: Equal
            value: another-value
            effect: NoSchedule
        template: gitops-operator/deployment.yaml
      # -- tunnel-client
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: another-value
            foo: bar
        template: tunnel-client.yaml
        documentSelector:
          path: kind
          value: Deployment
      - equal:
          path: spec.template.spec.tolerations
          value:
          - key: another-key
            operator: Equal
            value: another-value
            effect: NoSchedule
        template: tunnel-client.yaml
        documentSelector:
          path: kind
          value: Deployment
      # -- argo-rollouts controller
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: another-value
            foo: bar
        template: charts/argo-rollouts/templates/controller/deployment.yaml
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: another-key
              operator: Equal
              value: another-value
              effect: NoSchedule
        template: charts/argo-rollouts/templates/controller/deployment.yaml
      # -- argo-workflow controller
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: another-value
            foo: bar
        template: charts/argo-workflows/templates/controller/workflow-controller-deployment.yaml
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: another-key
              operator: Equal
              value: another-value
              effect: NoSchedule
        template: charts/argo-workflows/templates/controller/workflow-controller-deployment.yaml
      # -- argo-workflow server
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            some-key: another-value
            foo: bar
        template: charts/argo-workflows/templates/server/server-deployment.yaml
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: another-key
              operator: Equal
              value: another-value
              effect: NoSchedule
        template: charts/argo-workflows/templates/server/server-deployment.yaml
