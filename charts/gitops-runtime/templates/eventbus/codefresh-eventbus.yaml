{{- $eventBusName := default "codefresh-eventbus" .Values.global.runtime.eventBus.name }}
{{- $eventBusSpec := .Values.global.runtime.eventBus }}
{{/* Remove name from eventbus spec */}}
{{- if hasKey $eventBusSpec "name" }}
{{- $eventBusSpec = unset $eventBusSpec "name" }}
{{- end }}
{{/* Remove pdb from eventbus spec */}}
{{- if hasKey $eventBusSpec "pdb" }}
{{- $eventBusSpec = unset $eventBusSpec "pdb" }}
{{- end }}
{{- if hasKey $eventBusSpec "annotations" }}
{{- $eventBusSpec = unset $eventBusSpec "annotations" }}
{{- end }}

{{- $nodeSelector := $eventBusSpec.nats.native.nodeSelector | default dict }}
{{- $globalNodeSelector := .Values.global.nodeSelector | default dict }}
{{- $allNodeSelector := mergeOverwrite $globalNodeSelector $nodeSelector }}
{{- $_ := set $eventBusSpec.nats.native "nodeSelector" $allNodeSelector }}

{{- $tolerations := $eventBusSpec.nats.native.tolerations | default list }}
{{- $globalTolerations := .Values.global.tolerations | default list }}
{{- $allToleration := concat $globalTolerations $tolerations }}
{{- $_ := set $eventBusSpec.nats.native "tolerations" $allToleration }}

{{- $affinity := $eventBusSpec.nats.native.affinity | default dict }}
{{- $globalAffinity := .Values.global.affinity | default dict }}
{{- $allAffinity := mergeOverwrite $globalAffinity $affinity }}
{{- $_ := set $eventBusSpec.nats.native "affinity" $allAffinity }}

apiVersion: argoproj.io/v1alpha1
kind: EventBus
metadata:
  name: {{ $eventBusName }}
  annotations:
    {{- .Values.global.runtime.eventBus.annotations | toYaml | nindent 4}}
  labels:
    app.kubernetes.io/part-of: argo-events
    codefresh.io/internal: "true"
spec:
  {{- $eventBusSpec | toYaml | nindent 2}}
