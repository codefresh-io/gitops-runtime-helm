apiVersion: batch/v1
kind: Job
metadata:
  name: cleanup-runtime-resources
  annotations:
    helm.sh/hook: pre-delete
    helm.sh/hook-weight: "5"
    helm.sh/hook-delete-policy: hook-succeeded, before-hook-creation
spec:
  backoffLimit: 3
  template:
    spec:
      serviceAccount: runtime-cleanup
      restartPolicy: Never
      containers:
      - name: cleanup-runtime-resources
        image: "{{ .Values.installer.image.repository }}:{{ .Values.installer.image.tag | default .Chart.Version }}"
        imagePullPolicy: {{ .Values.installer.image.pullPolicy }}
        {{- include "installer.cleanup-resources.environment-variables" . | nindent 8}}
        command: ["sh", "-c"]
        args:
        - |
          set -e

          echo "[cleanup] Namespace: {{ .Release.Namespace }}"

          echo "[cleanup] Patching internal Argo CD Applications finalizers..."
          kubectl get applications -n {{ .Release.Namespace }} -l codefresh.io/internal=true -o jsonpath='{.items[*].metadata.name}' \
            | xargs -r -n1 -I{} sh -c 'echo "[cleanup] Patching application: {}"; kubectl patch application -n {{ .Release.Namespace }} {} -p '\''{"metadata":{"finalizers":null}}'\'' --type=merge' \
          || echo "[cleanup] Failed to patch applications (see errors above)"

          echo "[cleanup] Deleting codefresh-token secret..."
          kubectl delete secret codefresh-token -n {{ .Release.Namespace }} --ignore-not-found \
          || echo "[cleanup] Failed to delete codefresh-token (see errors above)"

          echo "[cleanup] Deleting default git integration secrets..."
          kubectl delete secret -n {{ .Release.Namespace }} -l 'io.codefresh.integration-type=git,io.codefresh.integration-name=default' --ignore-not-found \
          || echo "[cleanup] Failed to delete default git integration secrets (see errors above)"
      {{- with .Values.installer.nodeSelector | default .Values.global.nodeSelector }}
      nodeSelector: {{ toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.installer.tolerations | default .Values.global.tolerations}}
      tolerations: {{ toYaml . | nindent 6 }}
      {{- end }}
      {{- with .Values.installer.affinity }}
      affinity: {{ toYaml . | nindent 8 }}
      {{- end }}
